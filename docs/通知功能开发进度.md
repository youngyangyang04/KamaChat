# 通知功能开发进度文档

## 1. 概述

本文档记录通知功能的开发进度，包括已完成的功能和待开发的功能。

## 2. 已完成功能

### 2.1 数据模型和枚举

- ✅ **Notification 模型** (`internal/model/notification.go`)
  - 包含所有必要字段：uuid、user_id、type、title、content、related_id、related_type、sender_id、sender_name、sender_avatar、status、extra_data、created_at、read_at、deleted_at
  - 支持软删除

- ✅ **通知类型枚举** (`pkg/enum/notification/notification_type_enum/`)
  - 定义了9种通知类型：好友申请、群聊邀请、新消息、系统通知、群聊申请、好友申请已通过、好友申请已拒绝、群聊申请已通过、群聊申请已拒绝

- ✅ **通知状态枚举** (`pkg/enum/notification/notification_status_enum/`)
  - 定义了3种状态：未读、已读、已删除

### 2.2 数据传输对象（DTO）

- ✅ **请求对象（Request）**
  - `GetNotificationListRequest` - 获取通知列表请求
  - `GetUnreadCountRequest` - 获取未读数量请求
  - `MarkAsReadRequest` - 标记为已读请求
  - `DeleteNotificationRequest` - 删除通知请求
  - `ClearAllNotificationRequest` - 清空所有通知请求

- ✅ **响应对象（Respond）**
  - `NotificationListItem` - 通知列表项
  - `GetNotificationListResponse` - 获取通知列表响应（包含数据和总数）
  - `GetUnreadCountResponse` - 获取未读数量响应
  - `MarkAsReadResponse` - 标记为已读响应
  - `DeleteNotificationResponse` - 删除通知响应
  - `ClearAllNotificationResponse` - 清空所有通知响应

### 2.3 服务层（Service）

- ✅ **NotificationService** (`internal/service/gorm/notification_service.go`)
  - ✅ `CreateNotification` - 创建通知功能
  - ✅ `GetNotificationList` - 获取通知列表（支持分页、类型筛选、状态筛选）
  - ✅ `GetUnreadCount` - 获取未读通知数量（支持按类型筛选）
  - ✅ `MarkAsRead` - 标记通知为已读（支持批量标记或标记所有未读）
  - ✅ `DeleteNotification` - 删除通知（软删除，支持批量删除）
  - ✅ `ClearAllNotification` - 清空所有通知（支持按类型筛选）

### 2.4 控制器层（Controller）

- ✅ **NotificationController** (`api/v1/notification_controller.go`)
  - ✅ `GetNotificationList` - 获取通知列表接口
  - ✅ `GetUnreadCount` - 获取未读数量接口
  - ✅ `MarkAsRead` - 标记为已读接口
  - ✅ `DeleteNotification` - 删除通知接口
  - ✅ `ClearAllNotification` - 清空所有通知接口

### 2.5 路由注册

- ✅ 在 `internal/https_server/https_server.go` 中注册了所有通知相关接口
  - 所有接口都需要 JWT 认证
  - 接口路径前缀：`/notification/`

### 2.6 会话管理优化

- ✅ **双向会话创建机制**
  - 在 `PassContactApply` 函数中实现
  - 好友关系建立时自动创建双向会话
  - 避免每次发消息都检查反向会话，提升性能

## 3. 待开发功能

### 3.1 数据库迁移

- ⏳ **创建 notification 表**
  - 需要执行设计文档中的 SQL 语句创建数据库表
  - 包含所有必要的字段和索引

### 3.2 WebSocket 推送功能

- ⏳ **推送通知给在线用户**
  - 在 `internal/service/chat/server.go` 和 `internal/service/chat/kafka_server.go` 中实现 `PushNotification` 方法
  - 当创建通知时，如果用户在线，通过 WebSocket 实时推送
  - 推送消息格式：包含通知数据和未读数量

- ⏳ **推送消息格式定义**
  - 定义 `NotificationPushMessage` 结构
  - 包含通知数据和当前未读数量

### 3.3 业务逻辑集成

#### 3.3.1 好友申请流程

- ⏳ **好友申请通知**
  - 在 `ApplyContact` 函数中，当用户提交好友申请时，向被申请用户创建并推送通知
  - 通知类型：`NotificationTypeFriendApply`

- ⏳ **好友申请结果通知**
  - 在 `PassContactApply` 函数中，当申请通过时，向申请人创建并推送通知
  - 通知类型：`NotificationTypeContactAccepted`
  - 在 `RefuseContactApply` 函数中，当申请被拒绝时，向申请人创建并推送通知
  - 通知类型：`NotificationTypeContactRejected`

#### 3.3.2 群聊邀请流程

- ⏳ **群聊邀请通知**
  - 当用户被邀请加入群聊时，创建并推送通知
  - 通知类型：`NotificationTypeGroupInvite`

#### 3.3.3 群聊申请流程

- ⏳ **群聊申请通知**
  - 当用户申请加入群聊时，向群主/管理员创建并推送通知
  - 通知类型：`NotificationTypeGroupApply`

- ⏳ **群聊申请结果通知**
  - 当群聊申请通过时，向申请人创建并推送通知
  - 通知类型：`NotificationTypeGroupAccepted`
  - 当群聊申请被拒绝时，向申请人创建并推送通知
  - 通知类型：`NotificationTypeGroupRejected`

#### 3.3.4 新消息通知

- ⏳ **新消息通知逻辑**
  - 在消息处理逻辑中，判断用户是否在当前聊天窗口
  - 如果用户不在当前聊天窗口，创建并推送新消息通知
  - 通知类型：`NotificationTypeNewMessage`
  - 需要实现前端状态传递机制（用户当前聊天窗口信息）

- ⏳ **未读消息数量统计**
  - 在 `Session` 表中添加 `last_viewed_at` 字段
  - 实现 `GetUnreadMessageCount` 方法统计未读消息数量
  - 实现 `UpdateLastViewedAt` 方法更新最后查看时间
  - 实现 `GetTotalUnreadMessageCount` 方法获取所有会话的未读消息总数

- ⏳ **用户当前聊天窗口状态管理**
  - 前端传递当前聊天窗口信息给后端
  - 后端在 Redis 中存储用户的当前聊天窗口状态
  - 实现 `SetUserCurrentSession` 和 `GetUserCurrentSession` 方法
  - 实现 `ShouldPushNotification` 方法判断是否需要推送通知

#### 3.3.5 系统通知

- ⏳ **系统通知创建和推送**
  - 实现系统主动推送通知的机制
  - 通知类型：`NotificationTypeSystem`

### 3.4 前端功能

- ⏳ **通知列表组件** (`NotificationList.vue`)
  - 显示通知列表
  - 支持按类型筛选
  - 支持标记已读/删除
  - 显示未读数量角标
  - 分页加载

- ⏳ **通知项组件** (`NotificationItem.vue`)
  - 显示通知标题、内容、时间
  - 显示发送者头像和昵称
  - 支持点击跳转到相关页面
  - 支持标记已读/删除操作

- ⏳ **前端状态管理**
  - 在 Vuex store 中添加通知相关状态
  - `notifications` - 通知列表
  - `unreadCount` - 未读数量
  - `currentNotificationType` - 当前筛选的通知类型
  - 实现相关的 mutations 和 actions

- ⏳ **WebSocket 消息处理**
  - 在 WebSocket 消息处理中添加通知消息的处理逻辑
  - 接收到通知推送时，更新 Vuex 状态
  - 显示浏览器通知（需要用户授权）

- ⏳ **前端 API 调用**
  - 创建通知相关的 API 调用函数
  - `getNotificationList` - 获取通知列表
  - `getUnreadCount` - 获取未读数量
  - `markAsRead` - 标记为已读
  - `deleteNotification` - 删除通知
  - `clearAllNotification` - 清空所有通知

- ⏳ **当前聊天窗口状态管理**
  - 前端在打开聊天窗口时，告诉后端当前聊天窗口
  - 前端在切换聊天窗口时，更新当前聊天窗口状态
  - 通过 WebSocket 或 API 传递状态信息

- ⏳ **浏览器通知**
  - 请求浏览器通知权限
  - 当收到新通知时，显示浏览器通知
  - 处理权限被拒绝的情况

### 3.5 会话最后查看时间功能

- ⏳ **数据库迁移**
  - 在 `Session` 表中添加 `last_viewed_at` 字段
  - 创建相关索引

- ⏳ **更新最后查看时间接口**
  - 创建接口供前端调用
  - 用户打开聊天窗口时更新 `last_viewed_at`
  - 用户切换聊天窗口时更新 `last_viewed_at`

- ⏳ **消息处理逻辑优化**
  - 在消息处理逻辑中，更新双向会话的 `last_message` 和 `last_message_at`
  - 不再需要检查并创建反向会话（已在好友关系建立时创建）

### 3.6 测试和优化

- ⏳ **单元测试**
  - 测试 NotificationService 的各个方法
  - 测试边界情况和错误处理

- ⏳ **集成测试**
  - 测试通知的创建、查询、更新、删除流程
  - 测试 WebSocket 推送功能

- ⏳ **性能优化**
  - 大量通知时的分页加载优化
  - 通知去重机制（避免重复通知）
  - 通知过期机制（自动清理旧通知）

- ⏳ **数据一致性**
  - 确保通知状态与业务数据的一致性
  - 例如：好友申请状态与通知状态的一致性

## 4. 开发优先级

### 高优先级（核心功能）

1. **数据库迁移** - 创建 notification 表
2. **WebSocket 推送功能** - 实现通知的实时推送
3. **好友申请流程集成** - 在好友申请流程中创建和推送通知
4. **前端通知列表组件** - 显示通知列表的基础功能

### 中优先级（重要功能）

5. **新消息通知** - 实现新消息通知逻辑和未读消息统计
6. **前端状态管理** - Vuex 状态管理和 WebSocket 消息处理
7. **会话最后查看时间** - 实现未读消息数量统计的基础功能
8. **群聊相关通知** - 群聊邀请和申请的通知

### 低优先级（优化功能）

9. **浏览器通知** - 增强用户体验
10. **通知去重和过期机制** - 性能优化
11. **系统通知** - 扩展功能
12. **测试和优化** - 完善功能

## 5. 注意事项

1. **WebSocket 推送时机**
   - 创建通知后立即检查用户是否在线
   - 如果在线，立即推送；如果离线，用户登录后查询

2. **通知去重**
   - 避免同一事件创建多个重复通知
   - 例如：同一好友申请不应该创建多个通知

3. **性能考虑**
   - 大量通知时使用分页加载
   - 考虑实现通知聚合（如"您有3条新消息"）

4. **数据一致性**
   - 确保通知状态与业务数据一致
   - 例如：好友申请被处理时，相关通知也应该更新

5. **用户体验**
   - 通知应该及时、准确
   - 避免重复提醒
   - 提供清晰的未读数量提示

## 6. 下一步开发计划

1. **第一步**：执行数据库迁移，创建 notification 表
2. **第二步**：实现 WebSocket 推送功能
3. **第三步**：集成好友申请流程的通知创建和推送
4. **第四步**：开发前端通知列表组件
5. **第五步**：实现新消息通知和未读消息统计
6. **第六步**：完善其他业务逻辑的通知集成
7. **第七步**：测试和优化

